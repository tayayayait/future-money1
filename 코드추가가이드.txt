// =================================================================================
// Simulation.tsxì— ì¶”ê°€í•  ì½”ë“œ ìŠ¤ë‹ˆí«
// =================================================================================

// ============ 1ë‹¨ê³„: 177ì¤„ ë’¤ì— ì¶”ê°€ (lifeEvents useMemo ë‹¤ìŒ) ============
  // ë§ì¶¤í˜• ê³µê²©ì  ì €ì¶• ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±
  const handleGenerateAggressiveScenario = async () => {
    if (allTransactions.length === 0) {
      toast.error('ê±°ë˜ ë‚´ì—­ì´ ë¶€ì¡±í•©ë‹ˆë‹¤', {
        description: 'ìµœê·¼ 3ê°œì›” ê±°ë˜ ë‚´ì—­ì´ í•„ìš”í•©ë‹ˆë‹¤.',
      });
      return;
    }

    if (monthlyExpense <= 0) {
      toast.error('ì§€ì¶œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', {
        description: 'ì§€ì¶œ ë‚´ì—­ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.',
      });
      return;
    }

    setIsGeneratingScenario(true);
    
    try {
      // 1. ê±°ë˜ ë‚´ì—­ ë¶„ì„
      const analysis = analyzeSpending(allTransactions, 3);
      
      if (analysis.categories.length === 0) {
        toast.error('ë¶„ì„í•  ì§€ì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤');
        setIsGeneratingScenario(false);
        return;
      }

      // 2. ëª©í‘œ ì €ì¶• ì¦ê°€ì•¡ ì„¤ì • (í˜„ì¬ ì§€ì¶œì˜ 20% ì ˆê° ëª©í‘œ)
      const targetSavingsIncrease = monthlyExpense * 0.20;
      
      // 3. ì¹´í…Œê³ ë¦¬ë³„ ì ˆê° ê³„íš ìƒì„±
      const reductions = generateCategoryReductions(analysis, targetSavingsIncrease);
      
      if (reductions.length === 0) {
        toast.error('ì ˆê° ê°€ëŠ¥í•œ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', {
          description: 'ì§€ì¶œ íŒ¨í„´ì„ ë” ë‹¤ì–‘í•˜ê²Œ ê¸°ë¡í•´ë³´ì„¸ìš”.',
        });
        setIsGeneratingScenario(false);
        return;
      }

      // 4. ì „ëµ ì„¤ëª… ìƒì„±
      const rationale = generateAnalysisSummary(analysis, reductions);

      // 5. ì‹œë‚˜ë¦¬ì˜¤ ê°ì²´ ìƒì„±
      const scenario = generateAggressiveSavingScenario(
        analysis,
        reductions,
        rationale
      );

      setCustomAggressiveScenario({
        ...scenario,
        analysis,
        reductions,
      });

      // í™œì„± ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒì„±ëœ ë§ì¶¤í˜• ì‹œë‚˜ë¦¬ì˜¤ë¡œ ë³€ê²½
      setActiveScenario('aggressive-saving-custom');

      toast.success('ì ˆì•½ ê³„íšì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¯', {
        description: `ì›” ${Math.round((reductions.reduce((sum, r) => sum + r.reductionAmount, 0)) / 10000)}ë§Œì› ì ˆê° ê°€ëŠ¥`,
      });
    } catch (error) {
      console.error('ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ì‹¤íŒ¨:', error);
      toast.error('ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    } finally {
      setIsGeneratingScenario(false);
    }
  };

// ============ 2ë‹¨ê³„: 560ì¤„ (ì°¨íŠ¸ Cardë¥¼ ë‹«ëŠ” </Card> ë‹¤ìŒì— ì¶”ê°€) ============
        {/* ê³µê²©ì  ì €ì¶• ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ë²„íŠ¼ */}
        {!hasNoData && !isLoading && (
          <Card className="bg-gradient-to-r from-primary/5 to-transparent border-primary/20">
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-primary/10 rounded-full">
                    <Target className="w-5 h-5 text-primary" />
                  </div>
                  <div>
                    <h3 className="font-semibold text-sm">ë§ì¶¤í˜• ì ˆì•½ ê³„íš</h3>
                    <p className="text-xs text-muted-foreground">
                      ê±°ë˜ ë‚´ì—­ì„ ë¶„ì„í•˜ì—¬ ì‹¤í–‰ ê°€ëŠ¥í•œ ì ˆì•½ ê°€ì´ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤
                    </p>
                  </div>
                </div>
                <Button
                  onClick={handleGenerateAggressiveScenario}
                  disabled={isGeneratingScenario || allTransactions.length === 0}
                  className="gap-2"
                >
                  {isGeneratingScenario ? (
                    <>
                      <Loader2 className="w-4 h-4 animate-spin" />
                      ë¶„ì„ ì¤‘...
                    </>
                  ) : (
                    <>
                      <Target className="w-4 h-4" />
                      ì ˆì•½ ê³„íš ìƒì„±
                    </>
                  )}
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

// ============ 3ë‹¨ê³„: 698ì¤„ (ë§ˆì§€ë§‰ Card ë‹«ëŠ” </Card> ë‹¤ìŒ, </div> ì•ì— ì¶”ê°€) ============
        {/* ë§ì¶¤í˜• ê³µê²©ì  ì €ì¶• ìƒì„¸ ì¹´ë“œ */}
        {customAggressiveScenario && activeScenario === 'aggressive-saving-custom' && (
          <motion.div
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1 }}
          >
            <AggressiveSavingCard
              categoryReductions={customAggressiveScenario.reductions}
              savingsRationale={customAggressiveScenario.savingsRationale}
              totalCurrentExpense={customAggressiveScenario.analysis.avgMonthlyExpense}
              totalTargetExpense={
                customAggressiveScenario.analysis.avgMonthlyExpense -
                customAggressiveScenario.reductions.reduce((sum: number, r: any) => sum + r.reductionAmount, 0)
              }
            />
            
            <div className="mt-6">
              <CategoryReductionChart categoryReductions={customAggressiveScenario.reductions} />
            </div>
          </motion.div>
        )}
